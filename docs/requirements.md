# グループTODO - 機能要件定義書

## ドキュメント概要

- **作成日**: 2025-11-04（修正版）
- **対象**: グループTODOアプリの機能要件
- **目的**: 実装済み機能の要件を正確に記録する
- **注意**: このドキュメントは現在の実装を正として記述しています（推測は一切含みません）

---

## 1. プロジェクト概要

### 1.1 目的

家族や知人とリアルタイムでTODOを共有・管理できるグループTODOアプリ。
買い物リストや家事の管理など、日常的なタスク管理を複数人で効率的に行う。

### 1.2 基本コンセプト

- **リアルタイム共有**: 知り合い同士でTODOをリアルタイムに共有
- **シンプル操作**: 誰でも簡単に使える直感的なUI
- **デバイスベース認証**: メールアドレス不要、デバイスに紐づく認証
- **招待制**: SNS要素なし、知り合いのみを招待
- **データ引き継ぎ対応**: デバイス変更時のデータ移行機能

### 1.3 ターゲットユーザー

- **家族**: 買い物リスト、家事分担の管理
- **同居人**: ルームメイトとの家事・買い物管理
- **小規模チーム**: 少人数グループでのタスク管理

### 1.4 技術スタック

- **フレームワーク**: Flutter 3.24+
- **状態管理**: StatefulWidget + Service Layer Pattern
- **バックエンド**: Supabase（PostgreSQL、認証、リアルタイム同期、Storage）
- **アーキテクチャ**: Service-based Architecture
- **オンライン必須**: データベース接続が前提のアプリケーション

### 1.5 主要機能

- **ユーザー管理**: デバイスベース認証、プロフィール管理、データ引き継ぎ
- **グループ管理**: グループ作成・編集・削除、メンバー招待・管理、並び順変更
- **TODO管理**: TODO作成・編集・削除・完了、コメント機能、一覧表示
- **定期TODO**: 繰り返しパターン設定、自動生成、一時停止・再開
- **運営機能**: コンテンツポリシー、アナウンス、お問い合わせ、エラーログ、メンテナンスモード
- **収益化**: バナー広告機能

---

## 2. ユーザー管理機能

### 2.1 ユーザー登録・認証

#### 2.1.1 デバイスベース認証

**要件**:
- アプリ初回起動時に自動的にユーザーを作成
- メールアドレス・電話番号の登録不要
- デバイスID（iOS: identifierForVendor、Android: 端末ID）で認証

**ユーザー作成時の自動設定**:
- ユーザー名: `ユーザー` + `8桁英数字` （例: ユーザーABC12345）
- ユーザーID（display_id）: 8桁英数字ランダムID（紛らわしい文字を除外: I/O/0/1）

#### 2.1.2 ユーザーID（display_id）

**要件**:
- 8桁英数字のランダムID
- グループ招待時に使用
- データ引き継ぎ時に使用
- 画面上での表示用ID

**特徴**:
- ユニーク（重複チェック実施）
- 大文字英字 + 数字のみ（紛らわしい文字除外: I/O/0/1）
- ユーザー自身が確認・共有可能

### 2.2 プロフィール管理

#### 2.2.1 プロフィール編集

**編集可能項目**:
- ユーザー名（必須、15文字まで入力可能）
- プロフィール画像（任意）

**制約**:
- コンテンツポリシーによる入力制限（後述）

### 2.3 データ引き継ぎ機能

#### 2.3.1 引き継ぎパスワード設定

**要件**:
- ユーザーID（display_id）+ パスワードでデータ引き継ぎ
- パスワードは8文字以上の任意の文字列
- 設定画面から引き継ぎパスワードを生成

**制約**:
- パスワードは一度設定すると上書き可能

#### 2.3.2 データ引き継ぎ実行

**要件**:
- 新デバイスでユーザーID + パスワードを入力
- 既存データを新デバイスに移行
- 旧デバイスのデータは保持（デバイス変更のみ）

**引き継がれるデータ**:
- ユーザー情報（名前、プロフィール画像）
- 所属グループ情報
- グループ内のTODO情報

---

## 3. グループ管理機能

### 3.1 グループ作成

**要件**:
- グループ名（必須、15文字まで入力可能）
- グループ説明（任意、200文字まで入力可能）
- グループアイコン（任意、画像アップロード）
- カテゴリ設定（買い物、家事、仕事、趣味、その他、未設定）

**自動設定**:
- 作成者が自動的にグループメンバー（role: owner）として追加される

**制約**:
- コンテンツポリシーによる入力制限

### 3.2 グループ編集

**編集可能項目**:
- グループ名（15文字まで入力可能）
- グループ説明（200文字まで入力可能）
- グループアイコン
- カテゴリ

**権限**:
- オーナーのみ編集可能

### 3.3 グループ削除

**要件**:
- グループを削除すると、関連するすべてのデータが削除される
- 削除されるデータ: グループ情報、メンバー情報、TODO、定期TODO

**権限**:
- オーナーのみ削除可能

**確認**:
- 削除前に確認ダイアログ（AlertDialog）を表示

### 3.4 メンバー招待（承認制）

#### 3.4.1 招待方法

**要件**:
- ユーザーIDを入力してメンバーを招待（8桁入力欄）
- 招待時にロール（権限）を指定: オーナー or メンバー

**招待フロー**:
1. グループメンバーが招待したいユーザーのユーザーIDを入力
2. 招待されたユーザーが次回グループ画面を開いた時に「承認待ちの招待」セクションに表示される
3. 招待されたユーザーが承認・拒否を選択
4. 承認された場合のみグループに追加

#### 3.4.2 招待の表示

**要件**:
- グループ画面を開いた時に「承認待ちの招待」セクションに表示
- 承認・拒否・キャンセルの選択が可能

**表示情報**:
- グループ名
- グループアイコン
- 招待者名
- 招待されたロール（権限）

**注意**:
- プッシュ通知機能は実装されていません
- 別画面としての「招待一覧画面」は存在しません（グループ画面内のセクション表示のみ）

#### 3.4.3 招待のキャンセル

**要件**:
- 招待を送った側がキャンセル可能
- 招待された側が拒否可能

### 3.5 メンバー管理

#### 3.5.1 メンバー一覧表示

**表示項目**:
- メンバー名
- プロフィール画像
- ユーザーID（display_id）
- ロール（オーナー or メンバー）

**機能**:
- ユーザーIDタップでコピー（クリップボード）

#### 3.5.2 メンバーのロール変更

**要件**:
- オーナーがメンバーのロールを変更可能
- ロール: オーナー or メンバー

**権限**:
- オーナーのみ変更可能

#### 3.5.3 メンバー削除

**要件**:
- オーナーがメンバーを削除可能
- 削除されたメンバーはグループから退出

**権限**:
- オーナーのみ削除可能

#### 3.5.4 グループ退出

**要件**:
- メンバーは自分でグループから退出可能
- オーナーは退出不可（グループを削除する必要がある）

### 3.6 グループ並び順変更

**要件**:
- ユーザーごとにグループの表示順序をカスタマイズ可能
- ドラッグ&ドロップで順序変更

**保存**:
- 順序はユーザーごとに保存される（他のユーザーには影響しない）

---

## 4. TODO管理機能

### 4.1 TODO作成

**入力項目**:
- タイトル（必須、15文字まで入力可能）
- 詳細説明（任意、200文字まで入力可能）
- 期限（任意、日時選択）
- 担当者（複数選択可、デフォルトは作成者）
- カテゴリ（買い物、家事、その他、デフォルトは「その他」）

**所属先**:
- グループTODO: グループに紐づくTODO

**制約**:
- コンテンツポリシーによる入力制限

### 4.2 TODO編集

**編集可能項目**:
- タイトル（15文字まで入力可能）
- 詳細説明（200文字まで入力可能）
- 期限
- 担当者
- カテゴリ

**権限**:
- グループメンバー全員が編集可能

### 4.3 TODO削除

**要件**:
- TODOを削除すると完全に削除される（論理削除ではない）

**権限**:
- グループメンバー全員が削除可能

**確認**:
- 削除前に確認ダイアログを表示

### 4.4 TODO完了・未完了切り替え

**要件**:
- チェックボックスで完了・未完了を切り替え
- 完了時に完了日時を記録

**権限**:
- グループメンバー全員が切り替え可能

**表示**:
- 完了済みTODOは完了状態で表示（取り消し線）
- 未完了・完了済みの切り替え表示

### 4.5 TODO一覧表示

#### 4.5.1 My TODO画面（ホーム画面）

**表示内容**:
- 自分が担当のTODO一覧
- 期限でフィルタリング（当日、1週間以内、すべて）

**表示項目**:
- タイトル
- 期限
- グループ名
- カテゴリアイコン
- 完了状態

#### 4.5.2 グループ詳細画面

**表示内容**:
- 選択したグループのTODO一覧
- 未完了・完了済みの切り替え表示

**表示項目**:
- タイトル
- 期限
- 担当者アイコン
- カテゴリアイコン
- 完了状態

#### 4.5.3 並び順

**デフォルト並び順**:
- 未完了TODO: 期限が近い順 → 作成日時が新しい順
- 完了済みTODO: 完了日時が新しい順

### 4.6 TODOコメント機能

**要件**:
- TODOにコメントを追加可能
- コメント一覧を表示

**入力項目**:
- コメント内容（必須、データベース上は500文字まで）

**表示項目**:
- コメント内容
- 投稿者名
- 投稿日時

**権限**:
- グループメンバー全員がコメント可能

**制約**:
- コンテンツポリシーによる入力制限

---

## 5. 定期TODO機能

### 5.1 定期TODO作成

**入力項目**:
- タイトル（必須、15文字まで入力可能）
- 詳細説明（任意、200文字まで入力可能）
- カテゴリ（買い物、家事、その他、デフォルトは「その他」）
- 繰り返しパターン（必須）:
  - 毎日
  - 毎週（曜日指定）
  - 毎月（日付指定）
- 生成タイミング（必須、任意の時刻を指定可能）
- 担当者（複数選択可）

**動作**:
- 指定されたタイミングでTODOが自動生成される
- 生成されたTODOは通常のTODOと同じように扱われる

**制約**:
- コンテンツポリシーによる入力制限

### 5.2 定期TODO編集

**編集可能項目**:
- タイトル（15文字まで入力可能）
- 詳細説明（200文字まで入力可能）
- カテゴリ
- 繰り返しパターン
- 生成タイミング
- 担当者

**権限**:
- グループメンバー全員が編集可能

**注意**:
- 既に生成されたTODOには影響しない（次回生成分から反映）

### 5.3 定期TODO一時停止・再開

**要件**:
- 定期TODOを一時停止可能
- 停止中はTODOが生成されない
- 再開すると再びTODOが生成される

**権限**:
- グループメンバー全員が操作可能

### 5.4 定期TODO削除

**要件**:
- 定期TODOを削除すると、今後のTODO生成が停止される
- 既に生成されたTODOは削除されない

**権限**:
- グループメンバー全員が削除可能

**確認**:
- 削除前に確認ダイアログを表示

### 5.5 定期TODO一覧表示

**表示内容**:
- グループの定期TODO一覧
- アクティブ・停止中の状態表示

**表示項目**:
- タイトル
- 繰り返しパターン
- 生成タイミング
- 状態（アクティブ or 停止中）

**アクセス**:
- グループ詳細画面から定期TODO管理画面へ遷移

---

## 6. コンテンツポリシー機能

### 6.1 入力制限

**対象項目**:
- ユーザー名
- グループ名
- グループ説明
- TODOタイトル
- TODO詳細説明
- TODOコメント
- お問い合わせ内容

**禁止内容**:
- 個人情報（メールアドレス、電話番号、住所など）
- 誹謗中傷・差別的表現
- 公序良俗に反する内容
- 広告・宣伝・勧誘

### 6.2 検証タイミング

**サーバーサイド検証**:
- すべての入力は Edge Functions で検証
- 禁止ワードを含む場合はエラーを返す

**クライアントサイド表示**:
- 入力画面にコンテンツポリシーへのリンクを表示
- ユーザーが事前に確認可能

### 6.3 コンテンツポリシー画面

**表示内容**:
- 入力における注意事項
- 禁止事項の詳細説明
- 警告アイコンと黄色の強調表示

**アクセス**:
- 設定画面から遷移
- 各入力画面からリンク

---

## 7. アナウンス機能

### 7.1 アナウンス表示

**要件**:
- 運営からのお知らせを表示
- ホーム画面にアナウンスボタン表示

**表示項目**:
- タイトル
- 本文
- 公開日時

### 7.2 アナウンス管理

**管理項目**:
- バージョン番号による管理
- タイトル（100文字まで）
- 内容（1000文字まで）

---

## 8. お問い合わせ機能

### 8.1 お問い合わせ送信

**入力項目**:
- 問い合わせ種別（必須）:
  - 不具合報告
  - 機能要望
  - その他
- 問い合わせ内容（必須、1000文字まで入力可能）

**自動付加情報**:
- ユーザーID
- 送信日時
- 環境情報（dev/stg/prod）

**制約**:
- コンテンツポリシーによる入力制限

**送信後**:
- 送信完了メッセージを表示
- 運営側で内容を確認

---

## 9. エラーログ機能

### 9.1 エラー記録

**要件**:
- アプリ内で発生したエラーを自動記録
- サーバーに送信してログ保存

**記録情報**:
- エラーID
- エラー種別
- エラーメッセージ
- スタックトレース
- 発生画面
- ユーザーID
- 発生日時

### 9.2 エラーダイアログ表示

**表示内容**:
- エラーメッセージ
- エラーID（サポート問い合わせ用）
- 閉じるボタン

---

## 10. メンテナンスモード機能

### 10.1 メンテナンスモード

**要件**:
- メンテナンス中はアプリの利用を制限
- すべてのAPIリクエスト時にメンテナンス状態をチェック

**表示**:
- メンテナンスダイアログを表示
- メンテナンスメッセージを表示
- OKボタンのみ（操作不可）

**管理**:
- データベースのmaintenance_modeテーブルで管理
- 運営側で有効化・無効化

---

## 11. 広告機能

### 11.1 バナー広告

**表示場所**:
- ホーム画面下部
- グループ画面下部
- グループ詳細画面下部

**表示制御**:
- 環境ごとに表示ON/OFF設定
- dev環境: OFF
- stg環境: OFF
- prod環境: ON（予定）

---

## 12. 設定画面機能

### 12.1 ユーザー情報表示

**表示項目**:
- プロフィール画像
- ユーザー名
- ユーザーID（タップでコピー）

**操作**:
- プロフィール編集ボタン
- データ引き継ぎ設定ボタン

### 12.2 メニュー項目

**項目一覧**:
- プロフィール編集
- データ引き継ぎ設定
- アナウンス
- 入力における注意事項
- お問い合わせ

---

## 13. 画面遷移

### 13.1 アプリ起動フロー

1. **スプラッシュ画面**
   - 環境設定読み込み
   - ユーザー認証処理
   - データキャッシュ初期化

2. **メインタブ画面**
   - Bottom Navigation（ホーム、グループ、設定）

### 13.2 主要な画面遷移

- グループ画面 → グループ詳細 → 定期TODO管理
- グループ画面 → グループ詳細 → メンバー管理
- グループ画面 →「承認待ちの招待」セクション表示（画面内）
- 設定画面 → プロフィール編集
- 設定画面 → データ引き継ぎ設定
- 設定画面 → アナウンス
- 設定画面 → コンテンツポリシー
- 設定画面 → お問い合わせ

---

**最終更新日**: 2025-11-06
